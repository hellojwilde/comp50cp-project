<!DOCTYPE html>
<html lang="en">
<head>
  <title>Magic</title>
</head>
<body>
  <h1>Magic</h1>

  <erl>
    simulate_votes(RegistrarPid, Votes) ->
      lists:foreach(
        fun ({Name, Ballot}) ->
          RegistrarPid ! {register, self(), Name},
          receive
            {success, {Credential, BoothPid}, _RegistrarPid} ->
              BoothPid ! {ballot, self(), Credential, Ballot};
            _ -> fail
          after
            200 -> timeout
          end
        end,
        Votes
      ).
      
    out(A) ->
      ManagerPid = frontend_pids:get_manager_pid(A),
      RegistrarPid = frontend_pids:get_registrar_pid(A),

      case postvar(A, "type") of
        {ok, "simulate"} ->
          simulate_votes(RegistrarPid, [
            {"a", {vote, ["josh", "jonathan", "andrew", "anschel"], 1}},
            {"b", {vote, ["josh", "jonathan", "andrew", "anschel"], 2}},
            {"c", {vote, ["andrew", "jonathan", "josh", "anschel"], 3}},
            {"d", {vote, ["anschel", "jonathan", "andrew", "josh"], 1}},
            {"e", {vote, ["andrew", "jonathan", "anschel", "josh"], 2}},
            {"f", {vote, ["anschel", "jonathan", "andrew", "josh"], 4}},
            {"g", {vote, ["andrew", "jonathan", "anschel", "josh"], 2}}
          ]),
          {ehtml, {h2, [], ["Dumped in a bunch of votes."]}};
        {ok, "flush"} -> 
          ManagerPid ! flush,
          {ehtml, {h2, [], ["All booths flushed of votes."]}};
        _ -> ok
      end.
  </erl>

  <form method="post" action="/magic.yaws">
    <input type="hidden" name="type" value="flush"/>
    <input type="submit" value="Flush all votes!"/>
  </form>

  <form method="post" action="/magic.yaws">
    <input type="hidden" name="type" value="simulate"/>
    <input type="submit" value="Simulate some votes!"/>
  </form>
</body>
</html>